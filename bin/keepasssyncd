#!/bin/bash

mkdir -p .local/share/keepasssync

remote=~/.local/share/keepasssync/remote.kdb
parent=~/.local/share/keepasssync/parent.kdb
localcopy=~/.local/share/keepasssync/keepassx.kdb

[ -f $remote ] || download_remote_copy
[ -f $parent ] || cp -p $remote $parent
[ -f $localcopy ] || cp -p $remote $localcopy

hash(){
    sha1sum $1 | cut -d\  -f1
}

download_remote_copy(){
cat << EOF | sftp android@chmd.fr
lcd ~/.local/share/keepasssync
get -P keepassx.kdb remote.kdb
EOF
}

upload_local_copy(){
cat << EOF | sftp android@chmd.fr
lcd ~/.local/share/keepasssync
put -P keepassx.kdb
EOF
}

sync(){

download_remote_copy || exit

if [ "$(hash $remote)" == "$(hash $localcopy)" ]; then
    cp -p $localcopy $parent
    echo all copies are the same
    return
fi

if [ "$(hash $remote)" == "$(hash $parent)" ]; then
    if [ "$(hash $localcopy)" != "$(hash $parent)" ]; then
        upload_local_copy || exit
        cp -p $localcopy $parent
        notify-send "uploaded new keepass db"
        return
    fi
fi

if [ "$(hash $localcopy)" == "$(hash $parent)" ]; then
    if [ "$(hash $remote)" != "$(hash $parent)" ]; then
        cp -p $remote $localcopy
        cp -p $remote $parent
        notify-send "downloaded new keepass db"
        return
    fi
fi

if [ "$(hash $localcopy)" != "$(hash $parent)" ]; then
    if [ "$(hash $remote)" != "$(hash $parent)" ]; then
        notify-send -u critical "conflict between keepass databases"
        return
    fi
fi

}

while true; do
    sync
    sleep 120
done
