#!/bin/bash

# Configuration
readonly EXCLUDE_RECORDING_APPS='["parec", "wf-recorder"]'
readonly EXCLUDE_PLAYING_APPS='["speech-dispatcher-dummy"]'
readonly SLEEP_INTERVAL=1

INHIBIT_PID=""

apps_recording(){
    pactl -f json list source-outputs 2>/dev/null | jq -er \
        --argjson exclude "$EXCLUDE_RECORDING_APPS" '
        [.[]
        | select(.properties."application.process.id" != null)
        | select(.properties."application.name" | IN($exclude[]) | not)
        | .properties."application.name" // .properties."media.name" // "unknown app"]
        | unique
        | join(" ")
        '
}

apps_playing(){
    pactl -f json list sink-inputs 2>/dev/null | jq -er \
        --argjson exclude "$EXCLUDE_PLAYING_APPS" '
        [.[]
        | select(.corked == false)
        | select(.properties."application.name" | IN($exclude[]) | not)
        | .properties."application.name" // .properties."media.name" // "unknown app"]
        | unique
        | join(" ")
        '
}

start_inhibit(){
    [[ -n "$INHIBIT_PID" ]] && return

    systemd-inhibit --what=idle --who="Audio Monitor" --why="Busy Audio" sleep infinity &
    INHIBIT_PID=$!
}

stop_inhibit(){
    [[ -z "$INHIBIT_PID" ]] && return

    kill "$INHIBIT_PID" 2>/dev/null
    INHIBIT_PID=""
}

manage_inhibit(){
    local apps_recording="$1"
    local apps_playing="$2"

    if [[ -n "$apps_recording" || -n "$apps_playing" ]]; then
        start_inhibit
    else
        stop_inhibit
    fi
}

show_status(){
    local apps_recording="$1"
    local apps_playing="$2"
    local tooltip alt class

    # Determine state
    if [[ -n "$apps_playing" && -n "$apps_recording" ]]; then
        tooltip="Playing: ${apps_playing}\\nRecording: ${apps_recording}"
        alt="both"
        class="busy"
    elif [[ -n "$apps_recording" ]]; then
        tooltip="Recording: ${apps_recording}"
        alt="recording"
        class="busy"
    elif [[ -n "$apps_playing" ]]; then
        tooltip="Playing: ${apps_playing}"
        alt="playing"
        class="free"
    else
        tooltip="Idle"
        alt="idle"
        class="free"
    fi

    printf '{"tooltip": "%s", "alt": "%s", "class": "%s"}\n' "$tooltip" "$alt" "$class"
}

cleanup(){
    stop_inhibit
    exit 0
}

main(){
    trap cleanup SIGINT SIGTERM EXIT

    while true; do
        local apps_recording apps_playing

        apps_recording="$(apps_recording)"
        apps_playing="$(apps_playing)"

        manage_inhibit "$apps_recording" "$apps_playing"
        show_status "$apps_recording" "$apps_playing"

        sleep "$SLEEP_INTERVAL"
    done
}

main
