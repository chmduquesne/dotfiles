#!/bin/bash

SESSIONSDIR=$HOME/.dtach

new(){
  session="$1-$(date +%Y-%m-%d_%H:%M:%S)"
  dtach -A $SESSIONSDIR/$session $1
}

attach(){
  session=$(ls -1 $SESSIONSDIR | fzf --prompt "Select session to attach")
  [ $? == 0 ] && dtach -a "$SESSIONSDIR/$session"
}

terminate(){
  session=$(ls -1 $SESSIONSDIR | fzf --prompt "Select session to terminate")
  [ $? != 0 ] && return
  sockinfo=$(ss -xlpH src "$SESSIONSDIR/$session" | awk -F' ' '{print $NF}')
  [ -z "$sockinfo" ] && \
    echo "Could not identify process for $session" && return
  pid=$(echo "$sockinfo" | awk -F, '{print $2}' | sed 's/pid=//')
  kill $pid
}

arg=$1
shift
$arg $@
