#!/bin/bash

# Apps that we don't care if they record
WHITELIST='["parec", "wf-recorder3"]'

apps_recording(){
    # -e sets exit status to 1 if the output is empty/null
    pactl -f json list source-outputs | jq -er \
        --argjson wl "$WHITELIST" '
            [.[].properties["application.name"] | select(. and IN($wl[]) | not)]
            | if length > 0 then .[] else empty end'
}

show_status(){
    local apps="$1"
    if [[ -n "$apps" ]]; then
        printf '{"text": "", "tooltip": "Busy (%s)", "class": "busy"}\n' "$apps"
    else
        printf '{"text": "", "tooltip": "Free", "class": "free"}\n'
    fi
}

# Initial execution
PREV_APPS="$(apps_recording)"
show_status "$PREV_APPS"

# Monitor PulseAudio events
pactl subscribe | stdbuf -oL grep 'source-output' | while read -r _; do
    CURRENT_APPS=$(apps_recording)

    # Only update if the list of apps has actually changed
    if [[ "$CURRENT_APPS" != "$PREV_APPS" ]]; then
        show_status "$CURRENT_APPS"
        PREV_APPS="$CURRENT_APPS"
    fi
done
