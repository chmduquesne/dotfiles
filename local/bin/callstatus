#!/bin/bash

# Apps that we don't care if they record
WHITELIST='["parec", "wf-recorder3"]'

apps_recording(){
    pactl -f json list source-outputs | \
        jq --exit-status \
            --raw-output \
            --argjson wl "$WHITELIST" \
            '
                [
                    .[].properties["application.name"]
                    | select(
                        . != null and
                        ([. == $wl[]] | any | not)
                      )
                ]
                | select(length > 0)
                | .[]
            '

}

show_status(){
    if [ "$1" != "" ]; then
        printf '{"text": "", "tooltip": "In a call (%s)", "class": "busy"}\n' "$1"
    else
        printf '{"text": "", "tooltip": "Free", "class": "free"}\n'
    fi
}

APPS=$(apps_recording)
show_status "$APPS"
PREV_APPS="$APPS"


# subscribe to pactl events and runs the check for every change
stdbuf -oL pactl subscribe |
    grep --line-buffered 'source-output' |
    while read line; do
        APPS=$(apps_recording)
        if [ "$APPS" != "$PREV_APPS" ]; then
            show_status "$APPS"
        fi
        PREV_APPS="$APPS"
    done
