#!/bin/bash

RECORD_DIR="$(xdg-user-dir DOCUMENTS)/recordings"
MIX_SINK="recording_mix"
START_SOUND="/usr/share/sounds/freedesktop/stereo/bell.oga"
STOP_SOUND="/usr/share/sounds/freedesktop/stereo/complete.oga"

# Helper to kill stale audio modules
cleanup_audio() {
    pactl unload-module module-loopback 2>/dev/null
    pactl unload-module module-null-sink 2>/dev/null
}

case "$1" in
    start)
        # Prevent double instances
        pgrep -x "wf-recorder" > /dev/null && exit 0

        mkdir -p "$RECORD_DIR"
        cleanup_audio

        # 1. Create the virtual sink
        pactl load-module module-null-sink \
            sink_name=$MIX_SINK \
            sink_properties=device.description="Recording_Mix"

        # 2. Get current defaults
        MIC=$(pactl get-default-source)
        DESKTOP=$(pactl get-default-sink).monitor

        # 3. Connect sources to the mix
        pactl load-module module-loopback source=$MIC sink=$MIX_SINK
        pactl load-module module-loopback source=$DESKTOP sink=$MIX_SINK

        # 4. Start recording
        paplay $START_SOUND &
        wf-recorder \
            --audio=$MIX_SINK.monitor \
            -f "$RECORD_DIR/recording_$(date +%F_%T).mp4" &
        ;;
    stop)
        pkill -INT wf-recorder
        cleanup_audio
        paplay $STOP_SOUND &
        ;;
    toggle)
        pgrep -x wf-recorder > /dev/null && $0 stop || $0 start
        ;;
    status)
        PID=$(pgrep -x wf-recorder)
        if [ -n "$PID" ]; then
            # Calculate elapsed seconds
            START=$(date -d "$(ps -o lstart= -p "$PID")" +%s)
            ELAPSED=$(($(date +%s) - START))
            DURATION=$(date -u -d "@$ELAPSED" +%T)

            printf '{"text": "", "class": "recording", "tooltip": "Recording duration: %s"}\n' "$DURATION"
        else
            printf '{"text": "", "class": "idle"}\n'
        fi
        ;;
    *)
        echo "Usage: $0 [start|stop|toggle|status]"
esac
