#!/bin/bash

VIDEO_DIR="$(xdg-user-dir DOCUMENTS)/recordings"
MIX_NAME="wf_recorder_mix"

# Sound file paths (Standard on most distros)
START_SOUND="/usr/share/sounds/freedesktop/stereo/bell.oga"
STOP_SOUND="/usr/share/sounds/freedesktop/stereo/complete.oga"

# Helper to kill stale audio modules
cleanup_audio() {
    pactl unload-module module-loopback 2>/dev/null
    pactl unload-module module-null-sink 2>/dev/null
}



case "$1" in
    start)
        if ! pgrep -x "wf-recorder" > /dev/null; then
            mkdir -p "$VIDEO_DIR"
            cleanup_audio
            paplay $START_SOUND &

            # Identify Default Devices
            MIC=$(pactl get-default-source)
            SINK_MONITOR=$(pactl get-default-sink).monitor

            # Create virtual mix
            pactl load-module module-null-sink sink_name=$MIX_NAME sink_properties=device.description="Recording_Mix"
            pactl load-module module-loopback source=$MIC sink=$MIX_NAME
            pactl load-module module-loopback source=$SINK_MONITOR sink=$MIX_NAME

            wf-recorder --audio=$MIX_NAME.monitor -f "$VIDEO_DIR/recording_$(date +'%Y-%m-%d_%H-%M-%S').mp4" &
        fi
        ;;
    stop)
        pkill -INT wf-recorder
        cleanup_audio
        paplay $STOP_SOUND &
        ;;
    toggle)
        pgrep -x "wf-recorder" > /dev/null && $0 stop || $0 start
        ;;
    status)
        PID=$(pgrep -x "wf-recorder")
        if [ -n "$PID" ]; then
            # Calculate elapsed seconds
            START=$(date -d "$(ps -o lstart= -p "$PID")" +%s)
            ELAPSED=$(($(date +%s) - START))
            DURATION=$(date -u -d "@$ELAPSED" +%T)

            echo "{\"text\": \" $DURATION\", \"alt\": \"recording\", \"class\": \"recording\"}"
        else
            echo "{\"text\": \"\", \"alt\": \"idle\", \"class\": \"idle\"}"
        fi
        ;;
    *)
        echo "Usage: $0 [start|stop|toggle|status]"
esac
