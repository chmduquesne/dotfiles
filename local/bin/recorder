#!/bin/bash

VIDEO_DIR="$(xdg-user-dir DOCUMENTS)/recordings"
MIX_NAME="wf_recorder_mix"
START_SOUND="/usr/share/sounds/freedesktop/stereo/bell.oga"
STOP_SOUND="/usr/share/sounds/freedesktop/stereo/complete.oga"

# Helper to kill stale audio modules
cleanup_audio() {
    pactl unload-module module-loopback 2>/dev/null
    pactl unload-module module-null-sink 2>/dev/null
}

case "$1" in
    start)
        # Prevent double instances
        pgrep -x "wf-recorder" > /dev/null && exit 0

        mkdir -p "$VIDEO_DIR"
        cleanup_audio

        # 1. Create the virtual sink
        pactl load-module module-null-sink \
            sink_name=$MIX_NAME \
            sink_properties=device.description="Recording_Mix"

        # 2. Get current defaults
        MIC=$(pactl get-default-source)
        SINK_MONITOR=$(pactl get-default-sink).monitor

        # 3. Connect sources to the mix
        pactl load-module module-loopback source=$MIC sink=$MIX_NAME
        pactl load-module module-loopback source=$SINK_MONITOR sink=$MIX_NAME

        # 4. Start recording
        paplay $START_SOUND &
        wf-recorder \
            --audio=$MIX_NAME.monitor \
            -f "$VIDEO_DIR/recording_$(date +%F_%T).mp4" &
        ;;
    stop)
        pkill -INT wf-recorder
        cleanup_audio
        paplay $STOP_SOUND &
        ;;
    toggle)
        pgrep -x "wf-recorder" > /dev/null && $0 stop || $0 start
        ;;
    status)
        PID=$(pgrep -x "wf-recorder")
        if [ -n "$PID" ]; then
            # Calculate elapsed seconds
            START=$(date -d "$(ps -o lstart= -p "$PID")" +%s)
            ELAPSED=$(($(date +%s) - START))
            DURATION=$(date -u -d "@$ELAPSED" +%T)

            printf '{"text": " %s", "alt": "recording", "class": "recording"}\n' "$DURATION"
        else
            printf '{"text": "", "alt": "idle", "class": "idle"}\n'
        fi
        ;;
    *)
        echo "Usage: $0 [start|stop|toggle|status]"
esac
